<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rapor Pertemuan → PDF & WhatsApp (Responsive, v2)</title>
  <style>
    :root { --wa:#25D366; --wa-dark:#1DA851; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f5f7fb; margin:0; padding:16px; }
    .wrap { max-width: 980px; margin: 0 auto; display: grid; gap: 16px; }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.06); }
    h1 { font-size:20px; margin: 0 0 10px; }
    h2 { font-size:16px; margin: 0 0 8px; color:#111827; }
    label { display:block; font-weight:600; font-size:13px; margin-top:10px; color:#374151; }
    input[type="text"], input[type="date"], textarea, input[type="number"], select {
      width:100%; padding:10px; margin-top:6px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; background:#fff;
    }
    textarea { min-height:96px; resize:vertical; }
    .row { display:grid; grid-template-columns: 1fr; gap:12px; }
    .btn { appearance:none; border:0; background:var(--wa); color:#fff; padding:12px 14px; border-radius:12px; font-size:15px; cursor:pointer; }
    .btn:active { background:var(--wa-dark); }
    .btn.secondary { background:#111827; }
    /* Updated small button styling for consistent height and centering */
    .btn.small {
      padding: 0 10px; /* No vertical padding, height will define vertical size */
      border-radius:10px;
      font-size:13px;
      height: 33px; /* Fixed height */
      line-height: 33px; /* Centers single-line text vertically */
      display: inline-flex; /* Use flexbox for robust vertical alignment */
      align-items: center; /* Centers content vertically */
      justify-content: center; /* Centers content horizontally */
      vertical-align: middle; /* Ensures inline elements align correctly with text around them */
      cursor: pointer;
      margin-top: 0; /* <<< KUNCI PERBAIKAN: Hapus margin-top untuk tombol-label ini */
    }
    .btn:active { background:var(--wa-dark); } /* Re-apply active state */

    .grid-2 { display:grid; grid-template-columns: 1fr; gap:16px; }
    .right-column-stack { /* New container for stacking Preview and Settings on the right */
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    /* Styles for general checklist display */
    .lesson-list {
        display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; /* Standard margin-top */
    }
    .lesson-item {
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      padding:8px 10px;
      border-radius:10px;
      display:flex;
      gap:8px;
      align-items:center;
      position: relative;
    }
    .lesson-item .delete-subject-btn {
      appearance: none;
      border: 0;
      background: #dc2626;
      color: #fff;
      font-size: 10px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      margin-left: 8px;
      flex-shrink: 0;
    }
    .lesson-item .delete-subject-btn:active {
      background: #b91c1c;
    }

    /* New styles for selection dropdown */
    .lesson-selection-group {
      margin-bottom: 12px;
    }
    .lesson-selection-group label {
      margin-top: 0;
      margin-bottom: 4px;
    }
    .lesson-category-display-area {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px;
        background: #f9fafb;
        min-height: 80px;
    }

    .preview table { width:100%; border-collapse: collapse; font-size:13px; }
    .preview th, .preview td { padding:8px; border:1px solid #e5e7eb; vertical-align: top; }
    .preview th { background:#f9fafb; text-align:left; }
    .muted { color:#6b7280; font-size:12px; }
    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    /* Styles for the new settings card */
    .settings-card {
      background:#fff;
      border-radius:14px;
      padding:16px;
      box-shadow:0 8px 30px rgba(0,0,0,.06);
    }
    .settings-group {
        border-top: 1px solid #e5e7eb;
        padding-top: 12px;
        margin-top: 12px;
    }
    .settings-group:first-child {
        border-top: none;
        padding-top: 0;
        margin-top: 0;
    }
    .settings-group h3 {
        font-size: 14px;
        margin-top: 0;
        margin-bottom: 10px;
        color: #374151;
    }
    .settings-group .actions {
        margin-top: 0;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 8px; /* Tighter gap for buttons */
    }
    /* Specific width for settings action buttons */
    .settings-group .actions .btn.small {
        flex-grow: 0;
        flex-shrink: 0;
        width: 80px; /* Fixed width: 80px */
    }
    .settings-group input[type="file"] {
        display: none;
    }
    /* Specific layout for Add/Delete Category */
    .category-management-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 16px;
        align-items: center;
    }
    .category-management-row input[type="text"] {
        flex-grow: 1;
        min-width: 150px;
    }
    .category-edit-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
        align-items: center;
    }
    .category-edit-row input[type="text"] {
        flex-grow: 1;
        min-width: 150px;
    }
    .error { color:#b91c1c; font-size:12px; margin-top:8px; display:none; }
    
    /* Styling for Log Activity Table */
    #activityLogContainer table {
        width: 100%;
        border-collapse: collapse;
    }
    #activityLogContainer th,
    #activityLogContainer td {
        padding: 8px;
        border: 1px solid #e5e7eb;
        vertical-align: top;
        text-align: left;
    }
    #activityLogContainer th {
        background: #f9fafb;
    }


    @media (min-width: 880px) {
      .grid-2 { grid-template-columns: 1.1fr 1fr; }
    }
  </style>
  <!-- Libraries via jsDelivr (lebih stabil) -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Rapor Pertemuan → PDF & WhatsApp <span class="muted">(v2)</span></h1>
      <div class="muted">Isi data pertemuan, pilih pelajaran (bisa tambah manual), aktivitas, dan hasil. PDF akan dibuat lalu kamu bisa bagikan via WhatsApp (attach manual).</div>
      <div id="libError" class="error"></div>
    </div>

    <div class="grid-2">
      <!-- Left Column: Form -->
      <div class="card">
        <h2>Form Input</h2>
        <div class="row">
          <div>
            <label>Pertemuan</label>
            <input type="number" id="pertemuan" placeholder="Mis. 1" min="1" />
          </div>
          <div>
            <label>Tanggal</label>
            <input type="date" id="tanggal" />
          </div>
          <div>
            <label>Pelajaran (Checklist)</label>
            <!-- Dropdown untuk memilih kategori pelajaran yang akan ditampilkan -->
            <div class="lesson-selection-group">
                <label for="selectLessonCategoryDisplay">Pilih Kelompok Pelajaran untuk Dilihat:</label>
                <select id="selectLessonCategoryDisplay">
                    <!-- Options akan dimuat oleh JavaScript -->
                </select>
            </div>
            <!-- Container tempat checklist pelajaran yang terpilih akan dimuat -->
            <div id="activeLessonChecklistContainer" class="lesson-category-display-area">
              <div class="muted">Pilih kelompok pelajaran dari dropdown di atas.</div>
            </div>

            <!-- UI untuk menambah/menghapus kelompok pelajaran -->
            <div class="category-management-row">
              <input type="text" id="categoryNew" placeholder="Tambah kelompok pelajaran..." />
              <button class="btn small secondary" id="btnAddCategory" type="button">Tambah Kelompok</button>
              <button class="btn small secondary" id="btnDeleteCategory" style="background:#dc2626;" type="button">Hapus Kelompok</button>
            </div>
            <div class="muted">Buat kelompok pelajaran baru atau hapus kelompok yang dipilih dari dropdown di atas.</div>

            <!-- UI untuk mengganti nama kelompok terpilih -->
            <div class="category-edit-row">
                <input type="text" id="editCategoryName" placeholder="Nama kelompok terpilih..." readonly />
                <button class="btn small secondary" id="btnRenameCategory" type="button">Ganti Nama</button>
            </div>
            <div class="muted">Pilih kelompok dari dropdown "Pilih Kelompok Pelajaran" di atas untuk mengganti namanya.</div>

            <!-- UI untuk menambah pelajaran ke kelompok terpilih -->
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; align-items:center;">
              <select id="selectLessonCategoryToAdd" style="flex-grow:1; min-width: 120px;">
                <!-- Options akan dimuat oleh JavaScript -->
              </select>
              <input type="text" id="lessonNew" placeholder="Tambah pelajaran ke kelompok terpilih..." style="flex-grow:2;"/>
              <button class="btn small secondary" id="btnAddLesson" type="button">Tambah Pelajaran</button>
            </div>
            <div class="muted">Tambahkan pelajaran baru ke kelompok yang sudah ada melalui dropdown.</div>
          </div>
          <div>
            <label>Aktivitas</label>
            <textarea id="aktivitas" placeholder="Contoh: Latihan soal pecahan, membaca cerita pendek, eksperimen sederhana"></textarea>
          </div>
          <div>
            <label>Hasil (untuk orang tua)</label>
            <textarea id="hasil" placeholder="Ringkasan capaian, progress, dan catatan untuk orang tua"></textarea>
          </div>
          <div>
            <label>Nomor WhatsApp Orang Tua (format 628...)</label>
            <input type="text" id="waNumber" placeholder="628xxxxxxxxxx" />
          </div>
          <div>
            <label>Nama Coach (untuk log)</label>
            <input type="text" id="coachName" placeholder="Contoh: Coach Budi" />
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnGenerate">Generate PDF & Buka WhatsApp</button>
          <button class="btn secondary" id="btnPreview">Perbarui Preview Tabel</button>
        </div>
        <div class="muted">File PDF akan diunduh ke perangkat Anda. Sebuah tab baru akan terbuka untuk WhatsApp. Anda perlu melampirkan file PDF tersebut secara manual di chat WhatsApp.</div>
      </div>

      <!-- Right Column: Stacked Preview & Settings -->
      <div class="right-column-stack">
        <!-- Preview -->
        <div class="card preview">
          <h2>Preview Tabel (sebelum PDF)</h2>
          <table id="previewTable">
            <thead>
              <tr>
                <th>Pertemuan</th>
                <th>Tanggal</th>
                <th>Pelajaran</th>
                <th>Aktivitas</th>
                <th>Hasil</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="muted">Isi form di kiri, lalu klik "Perbarui Preview Tabel".</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Settings Card -->
        <div class="settings-card">
          <h2>Pengaturan Aplikasi</h2>
          <div class="muted">Kelola data aplikasi Anda (Export/Import/Reset).</div>

          <div class="settings-group">
              <h3>Data Aplikasi</h3>
              <div class="actions">
                  <button class="btn small secondary" id="btnExportSettings">Export</button>
                  <label class="btn small secondary" for="fileInputSettings">
                      Import
                      <input type="file" id="fileInputSettings" accept=".json" />
                  </label>
                  <button class="btn small secondary" id="btnClearSettings">Reset</button>
              </div>
              <div class="muted">Export file pengaturan (.json) ke perangkat Anda untuk backup, atau import kembali untuk restore. Reset akan menghapus semua data kustom.</div>
          </div>
        </div>

        <!-- Log Aktivitas Coach -->
        <div class="card">
          <h2>Log Aktivitas Coach</h2>
          <div class="actions" style="margin-bottom:12px;">
            <button class="btn secondary" id="btnLoadLog">Muat Log Aktivitas</button>
            <input type="text" id="filterCoachName" placeholder="Filter berdasarkan Nama Coach..." style="flex-grow:1; margin-top:0;" />
          </div>
          <div id="activityLogContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; background: #fff;">
            <div class="muted">Klik "Muat Log Aktivitas" untuk melihat riwayat.</div>
            <!-- Log data will be rendered here -->
          </div>
        </div>

      </div>
    </div>

  </div>

  <script>
    // URL Web App Google Apps Script Anda. GANTI DENGAN URL ASLI!
    // Contoh: https://script.google.com/macros/s/AKfycbz_XXXXXXXXXXXX_YOUR_ID/exec
    const GOOGLE_APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwFlmXqTa4VzBGHtxqSihwES111-DvWE7nYf-RmqMdEL1eFBjuMSYxF1vdFNvfnupowNA/exec"; 

    // ======= Helper: tampilkan error lib kalau CDN gagal =======
    function showLibError(msg) {
      const el = document.getElementById('libError');
      el.style.display = 'block';
      el.textContent = msg;
    }

    async function ensureLibraries() {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        showLibError("Gagal memuat jsPDF dari CDN. Pastikan koneksi internet aktif atau coba reload halaman.");
        throw new Error("jsPDF not loaded");
      }
      const { jsPDF } = window.jspdf;
      const tmp = new jsPDF();
      if (typeof tmp.autoTable !== "function") {
        showLibError("Gagal memuat plugin jsPDF-AutoTable. Coba reload halaman.");
        throw new Error("autoTable not loaded");
      }
      if (!window.html2canvas) {
        showLibError("Gagal memuat html2canvas. Fallback render tabel ke gambar tidak tersedia.");
      }
    }

    // ======= Setup Pelajaran Default + Checklist Dinamis =======

    const initialLessonCategories = [
      { id: 'cat-umum', name: 'Umum', subjects: ["Matematika", "Bahasa Indonesia", "Bahasa Inggris", "IPA", "IPS", "Agama", "Seni Budaya", "Penjas", "TIK"] }
    ];
    let lessonCategories = []; // Ini akan diisi dari localStorage

    const activeLessonChecklistContainer = document.getElementById("activeLessonChecklistContainer");
    const selectLessonCategoryDisplay = document.getElementById("selectLessonCategoryDisplay");
    const selectLessonCategoryToAdd = document.getElementById("selectLessonCategoryToAdd");
    const editCategoryNameInput = document.getElementById("editCategoryName");
    
    const LOCAL_STORAGE_KEY_LESSON_CATEGORIES = "raporAppLessonCategoriesV2";
    const LOCAL_STORAGE_KEY_CHECKED_STATE = "raporAppCheckedLessonsV2";

    function generateUniqueId(prefix = 'id_') {
      return prefix + Date.now() + Math.floor(Math.random() * 1000);
    }

    function saveLessonCategoriesToLocalStorage() {
      try {
        localStorage.setItem(LOCAL_STORAGE_KEY_LESSON_CATEGORIES, JSON.stringify(lessonCategories));
      } catch (e) {
        console.error("Gagal menyimpan kategori pelajaran ke localStorage:", e);
      }
    }

    function loadLessonCategoriesFromLocalStorage() {
      try {
        const stored = localStorage.getItem(LOCAL_STORAGE_KEY_LESSON_CATEGORIES);
        if (stored) {
          lessonCategories = JSON.parse(stored);
        } else {
          lessonCategories = JSON.parse(JSON.stringify(initialLessonCategories));
          saveLessonCategoriesToLocalStorage();
        }
      } catch (e) {
        console.error("Gagal memuat kategori pelajaran dari localStorage:", e);
        lessonCategories = JSON.parse(JSON.stringify(initialLessonCategories));
      }
    }

    function saveCheckedLessonsToLocalStorage(checkedState) {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY_CHECKED_STATE, JSON.stringify(checkedState));
        } catch (e) {
            console.error("Gagal menyimpan status centang ke localStorage:", e);
        }
    }

    function loadCheckedLessonsFromLocalStorage() {
        try {
            const storedState = localStorage.getItem(LOCAL_STORAGE_KEY_CHECKED_STATE);
            return storedState ? JSON.parse(storedState) : {};
        } catch (e) {
            console.error("Gagal memuat status centang dari localStorage:", e);
            return {};
        }
    }

    function handleCheckboxChange() {
        const currentCheckedState = loadCheckedLessonsFromLocalStorage();
        const categoryId = this.dataset.categoryId;
        const subjectName = this.value;

        if (this.checked) {
            if (!currentCheckedState[categoryId]) {
                currentCheckedState[categoryId] = [];
            }
            if (!currentCheckedState[categoryId].includes(subjectName)) {
                currentCheckedState[categoryId].push(subjectName);
            }
        } else {
            if (currentCheckedState[categoryId]) {
                currentCheckedState[categoryId] = currentCheckedState[categoryId].filter(s => s !== subjectName);
                if (currentCheckedState[categoryId].length === 0) {
                    delete currentCheckedState[categoryId];
                }
            }
        }
        saveCheckedLessonsToLocalStorage(currentCheckedState);
        updatePreview();
    }

    function renderSelectedCategorySubjects(categoryIdToDisplay) {
      activeLessonChecklistContainer.innerHTML = "";

      const category = lessonCategories.find(cat => cat.id === categoryIdToDisplay);
      const persistentCheckedState = loadCheckedLessonsFromLocalStorage();

      if (!category) {
        activeLessonChecklistContainer.innerHTML = "<div class='muted'>Pilih kelompok pelajaran dari dropdown di atas.</div>";
        editCategoryNameInput.value = ""; // Clear edit field
        editCategoryNameInput.readOnly = true; // Make it read-only
        return;
      }

      editCategoryNameInput.value = category.name; // Set edit field to selected category name
      editCategoryNameInput.readOnly = false; // Make it editable

      const lessonListDiv = document.createElement("div");
      lessonListDiv.className = "lesson-list";

      if (category.subjects.length === 0) {
        const mutedText = document.createElement("div");
        mutedText.className = "muted";
        mutedText.textContent = `Belum ada pelajaran di kelompok "${category.name}". Tambahkan pelajaran menggunakan input di bawah.`;
        lessonListDiv.appendChild(mutedText);
      }

      category.subjects.forEach(subjectName => {
        const cbId = `lesson_cb_${category.id}_${subjectName.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const wrapper = document.createElement("label");
        wrapper.className = "lesson-item";
        wrapper.htmlFor = cbId;
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = cbId;
        cb.value = subjectName;
        cb.dataset.categoryId = category.id;
        cb.dataset.categoryName = category.name;

        if (persistentCheckedState[category.id] && persistentCheckedState[category.id].includes(subjectName)) {
          cb.checked = true;
        }
        cb.addEventListener('change', handleCheckboxChange);

        const span = document.createElement("span");
        span.textContent = subjectName;
        wrapper.appendChild(cb);
        wrapper.appendChild(span);

        // Tombol hapus pelajaran individu
        const deleteSubjectBtn = document.createElement("button");
        deleteSubjectBtn.className = "delete-subject-btn";
        deleteSubjectBtn.textContent = "x";
        deleteSubjectBtn.type = "button"; // Penting agar tidak submit form
        deleteSubjectBtn.title = `Hapus pelajaran ${subjectName}`;
        deleteSubjectBtn.dataset.categoryId = category.id;
        deleteSubjectBtn.dataset.subjectName = subjectName;
        deleteSubjectBtn.addEventListener('click', handleDeleteSubject);
        wrapper.appendChild(deleteSubjectBtn);

        lessonListDiv.appendChild(wrapper);
      });
      activeLessonChecklistContainer.appendChild(lessonListDiv);
    }

    function populateCategoryDropdowns(selectedDisplayId = null) {
      selectLessonCategoryDisplay.innerHTML = "";
      selectLessonCategoryToAdd.innerHTML = "";

      if (lessonCategories.length === 0) {
        selectLessonCategoryDisplay.innerHTML = "<option value=''>Tidak ada kelompok</option>";
        selectLessonCategoryToAdd.innerHTML = "<option value=''>Tidak ada kelompok</option>";
        editCategoryNameInput.value = "";
        editCategoryNameInput.readOnly = true;
        return;
      }

      lessonCategories.forEach(category => {
        const optionDisplay = document.createElement("option");
        optionDisplay.value = category.id;
        optionDisplay.textContent = category.name;
        selectLessonCategoryDisplay.appendChild(optionDisplay);

        const optionAdd = document.createElement("option");
        optionAdd.value = category.id;
        optionAdd.textContent = category.name;
        selectLessonCategoryToAdd.appendChild(optionAdd);
      });

      // Maintain selected value or set default
      if (selectedDisplayId && lessonCategories.some(cat => cat.id === selectedDisplayId)) {
          selectLessonCategoryDisplay.value = selectedDisplayId;
      } else {
          selectLessonCategoryDisplay.value = lessonCategories[0].id; // Fallback to first if initial or deleted
      }
      selectLessonCategoryToAdd.value = selectLessonCategoryDisplay.value;
      
      // Update the edit category name input based on currently selected display category
      const currentSelectedCategory = lessonCategories.find(cat => cat.id === selectLessonCategoryDisplay.value);
      editCategoryNameInput.value = currentSelectedCategory ? currentSelectedCategory.name : "";
      editCategoryNameInput.readOnly = !currentSelectedCategory;
    }


    document.getElementById("btnAddCategory").addEventListener("click", () => {
      const input = document.getElementById("categoryNew");
      const categoryName = (input.value || "").trim();
      if (!categoryName) {
        alert("Nama kelompok pelajaran tidak boleh kosong.");
        return;
      }
      if (lessonCategories.some(cat => cat.name.toLowerCase() === categoryName.toLowerCase())) {
        alert(`Kelompok pelajaran dengan nama "${categoryName}" sudah ada.`);
        return;
      }

      const newCategoryId = generateUniqueId('cat_');
      lessonCategories.push({ id: newCategoryId, name: categoryName, subjects: [] });
      input.value = "";
      saveLessonCategoriesToLocalStorage();
      populateCategoryDropdowns(newCategoryId);
      renderSelectedCategorySubjects(newCategoryId);
      updatePreview();
    });

    document.getElementById("btnAddLesson").addEventListener("click", () => {
      const subjectInput = document.getElementById("lessonNew");
      const subjectName = (subjectInput.value || "").trim();
      if (!subjectName) {
        alert("Nama pelajaran tidak boleh kosong.");
        return;
      }

      const selectedCategoryId = selectLessonCategoryToAdd.value;
      if (!selectedCategoryId) {
        alert("Pilih kelompok pelajaran terlebih dahulu.");
        return;
      }

      const targetCategory = lessonCategories.find(cat => cat.id === selectedCategoryId);
      if (targetCategory) {
        if (targetCategory.subjects.some(subj => subj.toLowerCase() === subjectName.toLowerCase())) {
          alert(`Pelajaran "${subjectName}" sudah ada di kelompok "${targetCategory.name}".`);
          return;
        }
        targetCategory.subjects.push(subjectName);
        subjectInput.value = "";
        saveLessonCategoriesToLocalStorage();

        const persistentCheckedState = loadCheckedLessonsFromLocalStorage();
        if (!persistentCheckedState[selectedCategoryId]) {
            persistentCheckedState[selectedCategoryId] = [];
        }
        persistentCheckedState[selectedCategoryId].push(subjectName); // Centang otomatis pelajaran baru
        saveCheckedLessonsToLocalStorage(persistentCheckedState);


        if (selectLessonCategoryDisplay.value === selectedCategoryId) {
            renderSelectedCategorySubjects(selectedCategoryId); // Render ulang hanya jika kategori aktif
        }
        updatePreview();
      }
    });

    selectLessonCategoryDisplay.addEventListener('change', () => {
        const selectedId = selectLessonCategoryDisplay.value;
        renderSelectedCategorySubjects(selectedId);
        // Perbarui input edit dengan nama kategori yang dipilih
        const selectedCategory = lessonCategories.find(cat => cat.id === selectedId);
        editCategoryNameInput.value = selectedCategory ? selectedCategory.name : "";
        editCategoryNameInput.readOnly = !selectedCategory; // Make read-only if no category selected
        updatePreview();
    });

    // --- Fitur Edit/Hapus Kelompok Pelajaran ---
    document.getElementById("btnRenameCategory").addEventListener("click", () => {
        const selectedId = selectLessonCategoryDisplay.value;
        const newName = editCategoryNameInput.value.trim();

        if (!selectedId) {
            alert("Pilih kelompok pelajaran yang ingin diganti namanya.");
            return;
        }
        if (!newName) {
            alert("Nama kelompok tidak boleh kosong.");
            return;
        }
        if (lessonCategories.some(cat => cat.name.toLowerCase() === newName.toLowerCase() && cat.id !== selectedId)) {
            alert(`Kelompok pelajaran dengan nama "${newName}" sudah ada.`);
            return;
        }

        const categoryToRename = lessonCategories.find(cat => cat.id === selectedId);
        if (categoryToRename) {
            categoryToRename.name = newName;
            saveLessonCategoriesToLocalStorage();
            populateCategoryDropdowns(selectedId); // Re-populate dropdowns to update names
            // No need to re-render subjects unless a checkbox was added/removed, name change doesn't affect that
            updatePreview();
            alert(`Nama kelompok berhasil diubah menjadi "${newName}".`);
        }
    });

    document.getElementById("btnDeleteCategory").addEventListener("click", () => {
        const selectedId = selectLessonCategoryDisplay.value;
        if (!selectedId) {
            alert("Pilih kelompok pelajaran yang ingin dihapus.");
            return;
        }
        if (lessonCategories.length === 1) {
            alert("Tidak dapat menghapus kelompok terakhir. Tambahkan kelompok baru terlebih dahulu jika Anda ingin menghapus ini.");
            return;
        }

        const categoryToDelete = lessonCategories.find(cat => cat.id === selectedId);
        if (categoryToDelete && confirm(`Apakah Anda yakin ingin menghapus kelompok pelajaran "${categoryToDelete.name}" beserta semua pelajarannya? Aksi ini tidak dapat dibatalkan.`)) {
            lessonCategories = lessonCategories.filter(cat => cat.id !== selectedId);
            saveLessonCategoriesToLocalStorage();

            // Hapus juga status centang untuk kategori ini
            const checkedState = loadCheckedLessonsFromLocalStorage();
            delete checkedState[selectedId];
            saveCheckedLessonsToLocalStorage(checkedState);

            populateCategoryDropdowns(); // Re-populate dropdowns
            renderSelectedCategorySubjects(selectLessonCategoryDisplay.value); // Render default selected (first)
            updatePreview();
            alert(`Kelompok "${categoryToDelete.name}" berhasil dihapus.`);
        }
    });

    // --- Fitur Hapus Pelajaran Individual ---
    function handleDeleteSubject(event) {
        const categoryId = event.target.dataset.categoryId;
        const subjectName = event.target.dataset.subjectName;

        const targetCategory = lessonCategories.find(cat => cat.id === categoryId);

        if (targetCategory && confirm(`Apakah Anda yakin ingin menghapus pelajaran "${subjectName}" dari kelompok "${targetCategory.name}"?`)) {
            targetCategory.subjects = targetCategory.subjects.filter(s => s !== subjectName);
            saveLessonCategoriesToLocalStorage();

            // Hapus juga dari status centang jika ada
            const checkedState = loadCheckedLessonsFromLocalStorage();
            if (checkedState[categoryId]) {
                checkedState[categoryId] = checkedState[categoryId].filter(s => s !== subjectName);
                if (checkedState[categoryId].length === 0) {
                    delete checkedState[categoryId];
                }
            }
            saveCheckedLessonsToLocalStorage(checkedState);

            renderSelectedCategorySubjects(categoryId); // Render ulang kelompok yang sama
            updatePreview();
            alert(`Pelajaran "${subjectName}" berhasil dihapus.`);
        }
    }


    function getFormattedSelectedLessons() {
      const selectedCategoryId = selectLessonCategoryDisplay.value;
      const checked = loadCheckedLessonsFromLocalStorage();

      if (!selectedCategoryId || !checked[selectedCategoryId] || checked[selectedCategoryId].length === 0) {
        return "-";
      }
      return checked[selectedCategoryId].join(", ");
    }


    // ======= Preview Table =======
    function updatePreview() {
      const pertemuan = document.getElementById("pertemuan").value || "-";
      const tanggal = document.getElementById("tanggal").value || "-";
      const aktivitas = document.getElementById("aktivitas").value || "-";
      const hasil = document.getElementById("hasil").value || "-";
      const pelajaran = getFormattedSelectedLessons();

      const tbody = document.querySelector("#previewTable tbody");
      tbody.innerHTML = "";
      const tr = document.createElement("tr");
      [pertemuan, tanggal, pelajaran, aktivitas, hasil].forEach(text => {
        const td = document.createElement("td"); td.textContent = text; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    document.getElementById("btnPreview").addEventListener("click", updatePreview);


    // ======= Helper: Device Detect + WA URL =======
    function isMobile() { return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

    function formatWhatsAppNumber(raw) {
        let cleaned = (raw || "").replace(/\D/g, "");
        if (cleaned.startsWith("0") && cleaned.length > 1) {
            cleaned = "62" + cleaned.substring(1);
        } else if (!cleaned.startsWith("62") && cleaned.length >= 8) {
            cleaned = "62" + cleaned;
        }
        return cleaned;
    }

    function waUrlForDevice(number, text) {
      const encoded = encodeURIComponent(text || "");
      if (isMobile()) {
        return `https://wa.me/${number}?text=${encoded}`;
      } else {
        return `https://web.whatsapp.com/send?phone=${number}&text=${encoded}`;
      }
    }

    // ======= Generate PDF (jsPDF + AutoTable) =======
    async function generatePdfBlob(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("RAPOR PERTEMUAN", 105, 16, { align:"center" });
      doc.setFontSize(10);
      doc.setFont("helvetica","normal");
      const madeAt = new Date().toLocaleString();
      doc.text(`Dibuat: ${madeAt}`, 105, 22, { align:"center" });

      doc.setFontSize(11);
      doc.text(`Pertemuan: ${data.pertemuan || "-"}`, 14, 32);
      doc.text(`Tanggal   : ${data.tanggal || "-"}`, 14, 38);

      const head = [[ "Pertemuan", "Tanggal", "Pelajaran", "Aktivitas", "Hasil" ]];
      const body = [[ data.pertemuan || "-", data.tanggal || "-", data.pelajaran || "-", data.aktivitas || "-", data.hasil || "-" ]];

      if (typeof doc.autoTable === "function") {
        doc.autoTable({
          startY: 44,
          head: head,
          body: body,
          styles: { font:"helvetica", fontSize: 10, cellPadding: 3, valign:'top' },
          headStyles: { fillColor:[241,245,249], textColor: 20, lineWidth:0.2, lineColor: [226,232,240] },
          bodyStyles: { lineWidth:0.2, lineColor: [226,232,240] },
          columnStyles: {
            0: { cellWidth: 22 },
            1: { cellWidth: 28 },
            2: { cellWidth: 46 },
            3: { cellWidth: 46 },
            4: { cellWidth: 46 },
          },
          styles: { overflow: 'linebreak' },
        });
      } else if (window.html2canvas) {
        const tableEl = document.getElementById("previewTable");
        const canvas = await html2canvas(tableEl, { scale: 2, backgroundColor: "#fff" });
        const imgData = canvas.toDataURL("image/png");
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 10;
        const imgWidth = pageWidth - margin * 2;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        doc.addImage(imgData, "PNG", margin, 44, imgWidth, imgHeight);
      } else {
        throw new Error("Tidak dapat membuat tabel di PDF (AutoTable/html2canvas tidak tersedia).");
      }

      return doc.output("blob");
    }

    async function downloadBlob(blob, filename="rapor_pertemuan.pdf") {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 15000);
    }

    async function handleGenerate() {
      const pertemuan = document.getElementById("pertemuan").value;
      const tanggal = document.getElementById("tanggal").value;
      const aktivitas = document.getElementById("aktivitas").value;
      const hasil = document.getElementById("hasil").value;
      const pelajaran = getFormattedSelectedLessons();
      const coachName = document.getElementById("coachName").value || "Unknown Coach"; // Ambil nama coach

      const waNumberInput = document.getElementById("waNumber");
      const waNumber = formatWhatsAppNumber(waNumberInput.value);
      waNumberInput.value = waNumber;

      if (!waNumber) {
        alert("Masukkan nomor WhatsApp (format 628...)");
        return;
      }

      // Data untuk dikirim ke Google Apps Script
      const reportData = {
        coachName: coachName,
        pertemuan: pertemuan,
        tanggal: tanggal,
        pelajaran: pelajaran,
        aktivitas: aktivitas,
        hasil: hasil
      };

      const btn = document.getElementById("btnGenerate");
      btn.disabled = true;
      btn.textContent = "Menyimpan data & Membuat PDF...";

      let whatsappWindow = null;

      try {
        whatsappWindow = window.open("", "_blank");
        if (whatsappWindow) {
          whatsappWindow.document.write("Mohon tunggu, mempersiapkan PDF dan membuka WhatsApp...");
          whatsappWindow.document.title = "Membuka WhatsApp...";
        } else {
          alert("Pop-up untuk WhatsApp diblokir. Harap izinkan pop-up atau buka WhatsApp secara manual setelah mengunduh PDF.");
        }

        // --- KIRIM DATA KE GOOGLE APPS SCRIPT ---
        console.log("Mengirim data rapor ke Google Apps Script:", reportData);
        // Pastikan GOOGLE_APPS_SCRIPT_WEB_APP_URL sudah diganti dengan URL Web App Anda yang asli
        if (GOOGLE_APPS_SCRIPT_WEB_APP_URL === "YOUR_WEB_APP_URL_HERE") {
          throw new Error("URL Web App Google Apps Script belum diatur. Silakan ganti 'YOUR_WEB_APP_URL_HERE' dengan URL asli Anda.");
        }
        const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded" // Format untuk e.parameter di GAS
          },
          body: new URLSearchParams(reportData).toString() // Konversi objek ke query string
        });
        const result = await response.json();
        if (result.status === "success") {
          console.log("Data berhasil disimpan di Google Sheet:", result.message);
          // Muat ulang log setelah data baru disimpan
          await loadAndRenderActivityLog();
        } else {
          console.error("Gagal menyimpan data ke Google Sheet:", result.message);
          alert("Gagal menyimpan data ke log. Silakan coba lagi. Detail: " + result.message);
          // Aktifkan kembali tombol dan tutup tab kosong jika ada error penyimpanan log
          btn.disabled = false;
          btn.textContent = "Generate PDF & Buka WhatsApp";
          if (whatsappWindow && !whatsappWindow.closed) { whatsappWindow.close(); } 
          return; // Hentikan proses jika penyimpanan gagal
        }
        // --- AKHIR KIRIM DATA KE GOOGLE APPS SCRIPT ---

        await ensureLibraries(); // Memastikan library PDF dimuat

        const dataForPdf = { pertemuan, tanggal, pelajaran, aktivitas, hasil };

        const blob = await generatePdfBlob(dataForPdf);
        await downloadBlob(blob);

        const summaryText = `Rapor pertemuan ${pertemuan || "-"} (${tanggal || "-"})\n\nPelajaran: ${pelajaran || "-"}\nAktivitas: ${aktivitas || "-"}\nHasil: ${hasil || "-"}\n\nSilakan lampirkan PDF rapor yang baru diunduh.`;
        const url = waUrlForDevice(waNumber, summaryText);

        if (whatsappWindow) {
          if (!whatsappWindow.closed) {
            whatsappWindow.location.href = url;
          } else {
            window.open(url, "_blank");
          }
        } else {
          window.open(url, "_blank");
        }

      } catch (err) {
        console.error("Terjadi kesalahan:", err);
        if (whatsappWindow && !whatsappWindow.closed) {
          try { whatsappWindow.close(); } catch (e) {}
        }
        alert("Terjadi kesalahan saat membuat PDF atau membuka WhatsApp. Detail: " + (err && err.message ? err.message : err));
      } finally {
        btn.disabled = false;
        btn.textContent = "Generate PDF & Buka WhatsApp";
      }
    }

    document.getElementById("btnGenerate").addEventListener("click", handleGenerate);

    ["pertemuan","tanggal","aktivitas","hasil"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("input", ()=> { setTimeout(updatePreview, 50); });
    });

    const waNumberInput = document.getElementById("waNumber");
    waNumberInput.addEventListener("blur", () => {
        waNumberInput.value = formatWhatsAppNumber(waNumberInput.value);
    });

    // ======= Fitur Export/Import/Reset Settings =======

    document.getElementById("btnExportSettings").addEventListener("click", () => {
        const settingsData = {
            lessonCategories: lessonCategories,
            checkedState: loadCheckedLessonsFromLocalStorage()
        };
        const filename = "rapor_settings.json";
        const blob = new Blob([JSON.stringify(settingsData, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert("Pengaturan berhasil diekspor.");
    });

    document.getElementById("fileInputSettings").addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loadedSettings = JSON.parse(e.target.result);
                // Basic validation for loaded data structure
                if (loadedSettings.lessonCategories && Array.isArray(loadedSettings.lessonCategories) && loadedSettings.checkedState && typeof loadedSettings.checkedState === 'object') {
                    lessonCategories = loadedSettings.lessonCategories;
                    saveLessonCategoriesToLocalStorage();
                    saveCheckedLessonsToLocalStorage(loadedSettings.checkedState);

                    populateCategoryDropdowns();
                    // Ensure a category is selected before rendering subjects
                    const currentDisplayCategoryId = selectLessonCategoryDisplay.value || (lessonCategories.length > 0 ? lessonCategories[0].id : null);
                    if (currentDisplayCategoryId) {
                      renderSelectedCategorySubjects(currentDisplayCategoryId);
                    }
                    updatePreview();
                    alert("Pengaturan berhasil diimpor.");
                } else {
                    alert("Format file pengaturan tidak valid. Pastikan berisi 'lessonCategories' (array) dan 'checkedState' (objek).");
                }
            } catch (error) {
                console.error("Gagal membaca atau mem-parse file pengaturan:", error);
                alert("Gagal memuat pengaturan. Pastikan file JSON yang valid.");
            }
            event.target.value = ''; // Reset input file agar bisa memilih file yang sama lagi
        };
        reader.readAsText(file);
    });

    document.getElementById("btnClearSettings").addEventListener("click", () => {
        if (confirm("Apakah Anda yakin ingin mereset semua pengaturan pelajaran ke default? Semua pelajaran kustom dan pilihan centang akan hilang.")) {
            localStorage.removeItem(LOCAL_STORAGE_KEY_LESSON_CATEGORIES);
            localStorage.removeItem(LOCAL_STORAGE_KEY_CHECKED_STATE);
            loadLessonCategoriesFromLocalStorage();
            populateCategoryDropdowns();
            renderSelectedCategorySubjects(selectLessonCategoryDisplay.value); // Re-render with default category
            updatePreview();
            alert("Pengaturan telah direset ke default.");
        }
    });

    // ======= Log Aktivitas Coach Functions =======
    const activityLogContainer = document.getElementById("activityLogContainer");
    const filterCoachNameInput = document.getElementById("filterCoachName");

    async function loadAndRenderActivityLog() {
      activityLogContainer.innerHTML = "<div class='muted'>Memuat log aktivitas...</div>";
      try {
        // Pastikan GOOGLE_APPS_SCRIPT_WEB_APP_URL sudah diganti dengan URL Web App Anda yang asli
        if (GOOGLE_APPS_SCRIPT_WEB_APP_URL === "YOUR_WEB_APP_URL_HERE") {
          throw new Error("URL Web App Google Apps Script belum diatur. Silakan ganti 'YOUR_WEB_APP_URL_HERE' dengan URL asli Anda.");
        }
        const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, { method: "GET" });
        const result = await response.json();

        if (result.status === "success" && Array.isArray(result.data)) {
          let reports = result.data;
          const filterText = filterCoachNameInput.value.trim().toLowerCase();

          if (filterText) {
            reports = reports.filter(report =>
              report.CoachName && String(report.CoachName).toLowerCase().includes(filterText)
            );
          }

          if (reports.length === 0) {
            activityLogContainer.innerHTML = "<div class='muted'>Tidak ada log aktivitas yang ditemukan.</div>";
            return;
          }

          // Buat tabel untuk menampilkan log
          const table = document.createElement("table");

          // Header tabel (sesuai urutan di Google Sheet)
          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");
          // Gunakan header asli dari GAS, tapi bisa diatur ulang untuk tampilan
          const displayHeadersMap = {
            "Timestamp": "Timestamp",
            "CoachName": "Coach",
            "Pertemuan": "Pertemuan",
            "Tanggal": "Tanggal",
            "Pelajaran": "Pelajaran",
            "Aktivitas": "Aktivitas",
            "Hasil": "Hasil"
          };
          
          // Pastikan urutan dan nama header di tampilan sesuai keinginan Anda
          const orderedDisplayHeaders = ["Timestamp", "CoachName", "Pertemuan", "Tanggal", "Pelajaran", "Aktivitas", "Hasil"];

          orderedDisplayHeaders.forEach(key => {
            const th = document.createElement("th");
            th.textContent = displayHeadersMap[key] || key; // Gunakan nama tampilan atau kunci asli
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);

          // Body tabel
          const tbody = document.createElement("tbody");
          reports.reverse().forEach(report => { // Tampilkan yang terbaru di atas
            const tr = document.createElement("tr");
            orderedDisplayHeaders.forEach(key => {
              const td = document.createElement("td");
              let value = report[key];
              if (key === "Timestamp") {
                value = value ? new Date(value).toLocaleString() : "-"; // Format timestamp agar lebih mudah dibaca
              } else if (key === "Tanggal") {
                // Tanggal dari GAS bisa berupa string YYYY-MM-DD atau objek Date
                value = value ? (value instanceof Date ? value.toISOString().split('T')[0] : String(value)) : "-";
              }
              td.textContent = value || "-";
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);

          activityLogContainer.innerHTML = ""; // Bersihkan pesan loading
          activityLogContainer.appendChild(table);

        } else {
          activityLogContainer.innerHTML = `<div class='error'>Gagal memuat log: ${result.message || "Kesalahan tidak dikenal"}</div>`;
        }
      } catch (error) {
        console.error("Kesalahan saat memuat log aktivitas:", error);
        activityLogContainer.innerHTML = `<div class='error'>Terjadi kesalahan saat memuat log. Periksa konsol untuk detail. Pastikan URL Apps Script sudah benar dan ter-deploy sebagai Web App dengan akses 'Anyone'.</div>`;
      }
    }

    // Event listener untuk tombol muat log
    document.getElementById("btnLoadLog").addEventListener("click", loadAndRenderActivityLog);

    // Event listener untuk filter
    filterCoachNameInput.addEventListener("input", () => {
      // Debounce filter agar tidak terlalu sering memuat ulang saat mengetik
      clearTimeout(filterCoachNameInput._timeout);
      filterCoachNameInput._timeout = setTimeout(loadAndRenderActivityLog, 300);
    });


    // Panggil fungsi muat dan render saat DOM siap
    document.addEventListener("DOMContentLoaded", () => {
      loadLessonCategoriesFromLocalStorage();
      populateCategoryDropdowns(); // Isi kedua dropdown saat start
      renderSelectedCategorySubjects(selectLessonCategoryDisplay.value); // Render kategori yang pertama terpilih
      updatePreview(); // Perbarui preview awal
      loadAndRenderActivityLog(); // Muat log aktivitas saat halaman dimuat
    });
  </script>
</body>
</html>
